services:
  openclaw:
    build:
      context: .
      args:
        - OPENCLAW_BETA=${OPENCLAW_BETA:-false}
    restart: always
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    env_file:
      - .env
    environment:
      # 1. TUTORIAL MODE: Connect directly to Docker (No Proxy)
      DOCKER_HOST: unix:///var/run/docker.sock
      # 2. NETWORK FIX: Bind to all interfaces so Healthchecks pass
      OPENCLAW_GATEWAY_BIND: "0.0.0.0"
      OPENCLAW_GATEWAY_PORT: 18789
      PORT: 18789
      NODE_ENV: production
      # 3. PATH FIX: Force Linux to look in every possible folder for the app
      PATH: "/usr/local/lib/node_modules/.bin:/usr/local/bin:/usr/bin:/bin:/data/.bun/bin"
      
      # Standard Configs
      OPENCLAW_ENABLE_WEBHOOK_PROXY: "1"
      OPENCLAW_STATE_DIR: /data/.openclaw
      OPENCLAW_WORKSPACE: /data/openclaw-workspace
      OPENCLAW_AUTO_BOOTSTRAP: "1"
      OPENCLAW_PRINT_ACCESS: "1"
      
      # Keep your existing keys
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      SERVICE_FQDN_OPENCLAW: ${SERVICE_FQDN_OPENCLAW}

    volumes:
      - openclaw-data:/data
      - openclaw-config:/root/.openclaw
      - openclaw-workspace:/root/openclaw-workspace
      # 4. DIRECT ACCESS: This is the magic line from the tutorial
      - /var/run/docker.sock:/var/run/docker.sock

    # 5. SELF-HEALING COMMAND
    # If 'openclaw' is missing, this command reinstalls it automatically on boot.
    command: >
      sh -c "npm list -g openclaw || npm install -g openclaw && bash /app/scripts/bootstrap.sh"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:18789/"]
      interval: 30s
      timeout: 20s
      retries: 5

  # Keep Helper Services (Internal Only)
  registry:
    image: registry:2
    restart: unless-stopped
    volumes:
      - registry-data:/var/lib/registry
    environment:
      REGISTRY_HTTP_SECRET: ${SERVICE_BASE64_REGISTRY}

  searxng:
    build:
      context: .
      dockerfile: searxng/Dockerfile
    restart: unless-stopped
    volumes:
      - searxng-data:/var/lib/searxng
    environment:
      SEARXNG_BASE_URL: http://searxng:8080
      SEARXNG_SERVER_SECRET_KEY: ${SERVICE_BASE64_SEARXNG}
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID

volumes:
  openclaw-data:
  openclaw-config:
  openclaw-workspace:
  searxng-data:
  registry-data:
