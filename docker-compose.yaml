services:
  registry:
    image: 'registry:2'
    restart: unless-stopped
    volumes:
      - 'registry-data:/var/lib/registry'
    environment:
      REGISTRY_HTTP_SECRET: '${SERVICE_BASE64_REGISTRY}'

  openclaw:
    build:
      context: .
      args:
        - 'OPENCLAW_BETA=${OPENCLAW_BETA:-false}'
    restart: unless-stopped
    expose:
      - "18789"
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    env_file:
      - .env
    environment:
      DOCKER_HOST: 'tcp://docker-proxy:2375'
      OPENCLAW_ENABLE_WEBHOOK_PROXY: '1'
      PORT: 18789
      NODE_ENV: production
      NODE_OPTIONS: '--max-old-space-size=4096'
      HOME: /data
      TERM: xterm-256color
      HISTFILE: /data/.bash_history
      HISTSIZE: 50000
      HISTSAVE: 50000
      HISTCONTROL: ignoreboth
      XDG_CONFIG_HOME: /data/.config
      XDG_DATA_HOME: /data/.local/share
      XDG_CACHE_HOME: /data/.cache
      NPM_CONFIG_CACHE: /data/.npm
      BUN_INSTALL: /data/.bun
      OPENCLAW_GATEWAY_BIND: lan
      OPENCLAW_GATEWAY_PORT: '${OPENCLAW_GATEWAY_PORT:-18789}'
      OPENCLAW_STATE_DIR: /data/.openclaw
      OPENCLAW_WORKSPACE: /data/openclaw-workspace
      OPENAI_API_KEY: '${OPENAI_API_KEY}'
      MINIMAX_API_KEY: '${MINIMAX_API_KEY}'
      ANTHROPIC_API_KEY: '${ANTHROPIC_API_KEY}'
      GEMINI_API_KEY: '${GEMINI_API_KEY}'
      KIMI_API_KEY: '${KIMI_API_KEY}'
      OPENCODE_API_KEY: '${OPENCODE_API_KEY}'
      MOONSHOT_API_KEY: '${KIMI_API_KEY}'
      TELEGRAM_BOT_TOKEN: '${TELEGRAM_BOT_TOKEN}'
      SANDBOX_CONTAINER: '${SANDBOX_CONTAINER:-false}'
      GOOGLE_MAPS_API_KEY: '${GOOGLE_MAPS_API_KEY}'
      NANOBANANA_API_KEY: '${NANOBANANA_API_KEY}'
      ELEVENLABS_API_KEY: '${ELEVENLABS_API_KEY}'
      SERVICE_URL_OPENCLAW_18789: null
      SERVICE_URL_OPENCLAWWEBHOOK_8788: null
      BASE_URL: 'https://${SERVICE_FQDN_OPENCLAW}'
      PUBLIC_URL: 'https://${SERVICE_FQDN_OPENCLAW}'
      OPENCLAW_AUTO_BOOTSTRAP: '1'
      OPENCLAW_PRINT_ACCESS: '1'
      GATEWAY_TRUSTED_PROXIES: '*'
      CHOKIDAR_USEPOLLING: 'true'
      CF_TUNNEL_TOKEN: '${CF_TUNNEL_TOKEN}'
      VERCEL_ORG_ID: '${VERCEL_ORG_ID}'
      VERCEL_PROJECT_ID: '${VERCEL_PROJECT_ID}'
      VERCEL_TOKEN: '${VERCEL_TOKEN}'
      GITHUB_TOKEN: '${GITHUB_TOKEN}'
      GITHUB_USERNAME: '${GITHUB_USERNAME}'
      GITHUB_EMAIL: '${GITHUB_EMAIL}'
      OPENCLAW_BETA: '${OPENCLAW_BETA:-false}'
    volumes:
      - 'openclaw-data:/data'
    depends_on:
      - docker-proxy
    healthcheck:
      test:
        - CMD
        - curl
        - '-f'
        - 'http://localhost:18789/'
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 300s

  docker-proxy:
    image: 'tecnativa/docker-socket-proxy:latest'
    restart: unless-stopped
    volumes:
      - '/var/run/docker.sock:/var/run/docker.sock:ro'
    environment:
      POST: 1
      CONTAINERS: 1
      IMAGES: 1
      NETWORKS: 1
      INFO: 1
      VERSION: 1
      EXEC: 1
      EVENTS: 1

  searxng:
    build:
      context: .
      dockerfile: searxng/Dockerfile
    restart: unless-stopped
    volumes:
      - 'searxng-data:/var/lib/searxng'
    environment:
      SEARXNG_BASE_URL: 'http://searxng:8080'
      SEARXNG_SERVER_SECRET_KEY: '${SERVICE_BASE64_SEARXNG}'
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID

volumes:
  openclaw-data: null
  searxng-data: null
  registry-data: null
